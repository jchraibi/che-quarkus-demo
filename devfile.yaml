apiVersion: 1.0.0
metadata:
  generateName: quarkus-che-demo-
projects:

  - source:
      type: git
      location: 'https://github.com/sunix/che-quarkus-demo'
      branch: microservices
    name: che-quarkus-demo

components:

  - alias: quarkus-backend-dev
    type: dockerimage
    image: quay.io/quarkus/centos-quarkus-maven:19.2.0.1
    memoryLimit: 2Gi
    command: ['sleep']
    args: ['infinity']
    mountSources: true
    volumes:
      - name: mavenrepo
        containerPath: /project/.m2
    env:
      - name: HOME
        value: /project
    endpoints:
      - name: 'quarkus/dev'
        port: 8080
  - alias: quarkus-backend
    type: dockerimage
    image: quay.io/quarkus/ubi-quarkus-native-image:19.2.0.1
    memoryLimit: 16M
    mountSources: true
    command: ['tail']
    args: ['-f', '/dev/null']
    endpoints:
      - name: '8080/tcp'
        port: 8080

  - alias: node-frontend-dev
    mountSources: true
    image: 'quay.io/eclipse/che-nodejs8-centos:7.2.0'
    memoryLimit: 512Mi
    type: dockerimage
    endpoints:
      - name: '3000/tcp'
        port: 3000


  - alias: git
    type: dockerimage
    image: sunix/git-devtools
    mountSources: true
    memoryLimit: 64M
    args: ['sleep', 'infinity']

  - alias: java
    type: chePlugin
    id: redhat/java/latest
    memoryLimit: 1536M

  - id: redhat/vscode-openshift-connector/0.0.21
    type: chePlugin
    alias: oc

  - id: ms-kubernetes-tools/vscode-kubernetes-tools/latest
    type: chePlugin

  - id: redhat/vscode-yaml/latest
    type: chePlugin

commands:

  - name: compile quarkus:dev
    actions:
      - type: exec
        command: pkill java; mvn compile quarkus:dev
        component: quarkus-backend-dev
        workdir: /projects/che-quarkus-demo/quarkus-backend

  - name: package
    actions:
      - type: exec
        command: pkill java; mvn package
        component: quarkus-backend-dev
        workdir: /projects/che-quarkus-demo/quarkus-backend

  - name: package -Pnative
    actions:
      - type: exec
        command: pkill java; mvn package -Pnative
        component: quarkus-backend-dev
        workdir: /projects/che-quarkus-demo/quarkus-backend

  - name: start quarkus-backend native
    actions:
      - type: exec
        command: ./quarkus-demo-1.0.0-SNAPSHOT-runner -Dquarkus.http.host=0.0.0.0
        component: quarkus-backend
        workdir: /projects/che-quarkus-demo/quarkus-backend/target

  - name: start dev node-frontend
    actions:
      - type: exec
        command: npm run start
        component: node-frontend-dev
        workdir: /projects/che-quarkus-demo/node-frontend/

  - name: compile node-frontend
    actions:
      - type: exec
        command: npm install
        component: node-frontend-dev
        workdir: /projects/che-quarkus-demo/node-frontend/


  - name: oc new app quarkus + frontend
    actions:
      - type: exec
        command: |-
                 oc new-app quay.io/quarkus/ubi-quarkus-native-s2i:19.2.0.1~https://github.com/sunix/che-quarkus-demo.git#microservices --name=quarkus-backend --context-dir=quarkus-backend
                 oc expose svc/quarkus-backend
                 export BK=http://$(oc get route quarkus-backend --template=''{{ .spec.host }}'')
                 oc new-app nodejs~https://github.com/sunix/che-quarkus-demo.git --context-dir=node-frontend --name=node-frontend -e REACT_APP_BACKEND_HOST=$BK
        component: oc
        workdir: /projects/che-quarkus-demo/node-frontend/




  - name: connect java debugger quarkus-backend
    actions:
      - type: vscode-launch
        referenceContent: |
          {
          "version": "0.2.0",
          "configurations": [
            {
              "type": "java",
              "name": "Debug (Attach) - Remote",
              "request": "attach",
              "hostName": "localhost",
              "port": 5005
            }]
          }
